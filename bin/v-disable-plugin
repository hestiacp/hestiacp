#!/usr/bin/env bash
# info: disable plugin
# options: PLUGIN_NAME
#
# example: v-disable-plugin pluginname

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

plugin_name="$1"

# shellcheck source=/etc/hestiacp/hestia.conf
source /etc/hestiacp/hestia.conf
# shellcheck source=/usr/local/hestia/func/main.sh
source $HESTIA/func/main.sh
# shellcheck source=/usr/local/hestia/func/plugins.sh
source $HESTIA/func/plugins.sh
# load config file
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '1' "$#" 'PLUGIN_NAME'

init_plugins_conf_if_not_exists

plugin_name="$(echo "$plugin_name" | awk '{gsub(/^[ \t]+| [ \t]+$/,""); print $0 }')"
plugin_path="$HESTIA/plugins/$plugin_name"
plugin_conf="$($HESTIA/bin/v-list-plugin "$plugin_name" plain)"

if [[ ! -d "$plugin_path" ]]; then
	check_result "$E_INVALID" "Plugin \"$plugin_name\" is not installed"
elif [[ "$(echo "$plugin_conf" | awk '{print $4}')" != "true" ]]; then
	check_result "$E_INVALID" "Plugin \"$plugin_name\" is already disabled"
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Check if plugin has an uninstall script
if [[ -f "$plugin_path/hook/pre_disable" ]]; then
    bash "$plugin_path/hook/pre_disable"
fi

# Remove CLI files
if [[ -d "$plugin_path/bin" ]]; then
    for f in "$plugin_path/bin/"*; do
        bin_name="$(basename -- "$f")"

        if [[ -L "$HESTIA/bin/$bin_name" ]]; then
            unlink "$HESTIA/bin/$bin_name"
        fi
    done
fi

# Remove from web
if [[ -L "$HESTIA/web/plugin/$plugin_name" ]]; then
    unlink "$HESTIA/web/plugin/$plugin_name"
fi

# Change plugin status
plugin_data="$(get_json_index "$plugin_name" $HESTIA/conf/plugins.json)"
plugin_data="$(update_json_index "enabled" "false" "$plugin_data")"
update_json_index "$plugin_name" "$plugin_data" $HESTIA/conf/plugins.json
