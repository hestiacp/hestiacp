#!/bin/bash
# info: delete firewall blocking rule
# options: IPV4_CIDR CHAIN
#
# example: v-delete-firewall-ban 198.11.130.250 MAIL
#
# This function deletes blocking rule from system firewall

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

# Argument definition
ipv4_cidr=$1
chain=$(echo $2 | tr '[:lower:]' '[:upper:]')

# Defining absolute path for iptables and fail2ban-client
iptables="/sbin/iptables"
f2bcli="/usr/bin/fail2ban-client"

# Includes
# shellcheck source=/etc/hestiacp/hestia.conf
source /etc/hestiacp/hestia.conf
# shellcheck source=/usr/local/hestia/func/main.sh
source $HESTIA/func/main.sh
# shellcheck source=/usr/local/hestia/func/firewall.sh
source $HESTIA/func/firewall.sh
# load config file
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '2' "$#" 'IPV4_CIDR CHAIN'
is_format_valid 'ipv4_cidr' 'chain'
is_system_enabled "$FIREWALL_SYSTEM" 'FIREWALL_SYSTEM'

# Perform verification if read-only mode is enabled
check_hestia_demo_mode

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Self heal iptables links
heal_iptables_links

conf="$HESTIA/data/firewall/banlist.conf"
if [ "$chain" == "ALL" ]; then
	check_ip=$(grep "IP='$ipv4_cidr' CHAIN='*'" $conf)
	if [ -z "$check_ip" ]; then
		exit
	fi
	grep "IP='$ipv4_cidr' CHAIN='*'" $conf | while read -r line; do
		parse_object_kv_list $line

		# Deleting ip from banlist
		sip=$(echo "$IP" | sed "s|/|\\\/|g")
		sed -i "/IP='$sip' CHAIN='$CHAIN'/d" $conf
		b=$($iptables -L fail2ban-$CHAIN --line-number -n | grep -w $ipv4_cidr | awk '{print $1}')
		$iptables -D fail2ban-$CHAIN $b 2> /dev/null
		for f2bjail in $("$f2bcli" status | grep -i 'Jail list:' | cut -d':' -f2- | sed -E 's/\s*//g' | tr ',' ' '); do
			if "$f2bcli" get "$f2bjail" actions | grep -Eq "^hestia-$CHAIN" 2> /dev/null; then
				"$f2bcli" set "$f2bjail" unbanip "$sip" &> /dev/null
			fi
		done
	done
else
	# Checking ip in banlist
	check_ip=$(grep "IP='$ipv4_cidr' CHAIN='$chain'" $conf 2> /dev/null)
	if [ -z "$check_ip" ]; then
		exit
	fi

	# Deleting ip from banlist
	sip=$(echo "$ipv4_cidr" | sed "s|/|\\\/|g")
	sed -i "/IP='$sip' CHAIN='$chain'/d" $conf
	b=$($iptables -L fail2ban-$chain --line-number -n | grep -w $ipv4_cidr | awk '{print $1}')
	$iptables -D fail2ban-$chain $b 2> /dev/null
	for f2bjail in $("$f2bcli" status | grep -i 'Jail list:' | cut -d':' -f2- | sed -E 's/\s*//g' | tr ',' ' '); do
		if "$f2bcli" get "$f2bjail" actions | grep -Eq "^hestia-$chain" 2> /dev/null; then
			"$f2bcli" set "$f2bjail" unbanip "$sip" &> /dev/null
		fi
	done

fi

# Changing permissions
chmod 660 $conf

#----------------------------------------------------------#
#                       Hestia                             #
#----------------------------------------------------------#

# Logging
$BIN/v-log-action "system" "Info" "Firewall" "Removed IP from ban list (IP: $ipv4_cidr, Service: $chain)."
log_event "$OK" "$ARGUMENTS"

exit
