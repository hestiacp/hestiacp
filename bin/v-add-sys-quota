#!/bin/bash
# info: add system quota
# options: NONE
#
# example: v-add-sys-quota
#
# This function enables filesystem quota on /home partition
# Supports XFS and ext4 (both external and native quotas)

#----------------------------------------------------------#
#                 Variable & Function                      #
#----------------------------------------------------------#

# Includes
# shellcheck source=/usr/local/hestia/func/main.sh
source $HESTIA/func/main.sh
# load config file
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

# Checking quota package
if ! type -P quota &> /dev/null; then
	export DEBIAN_FRONTEND=noninteractive
	apt-get -y install quota > /dev/null 2>&1
	check_result $? "quota package installation failed" "$E_UPDATE"
fi

# Perform verification if read-only mode is enabled
check_hestia_demo_mode

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Adding group and user quota on /home partition
mnt=$(df -P /home | awk '{print $6}' | tail -n1)
fs_type=$(df -T "$mnt" | awk '{print $2}' | tail -n1)
lnr=$(cat -n /etc/fstab | grep -v "#" | awk '{print $1,$3}' | grep "$mnt$" | cut -f 1 -d ' ')
opt=$(sed -n ${lnr}p /etc/fstab | awk '{print $4}')

case "$fs_type" in
	xfs)
		log_history "XFS filesystem detected on $mnt."
		
		# Check if /home is on root partition or separate partition
		if [[ "$mnt" == "/" ]]; then
			# /home is on root partition - modify GRUB
			log_history "/home is on root partition. Modifying GRUB for XFS quota."
			grub_conf="/etc/default/grub"

			if ! grep -q "rootflags=.*uquota" "$grub_conf" || ! grep -q "systemd.unified_cgroup_hierarchy=1" "$grub_conf"; then
				params="rootflags=uquota,pquota,gquota systemd.unified_cgroup_hierarchy=1"
				sed -i 's/^\(GRUB_CMDLINE_LINUX="[^"]*\)/\1 '"$params"'/' "$grub_conf"
				check_result $? "Failed to add kernel parameters to $grub_conf"
				update-grub > /dev/null 2>&1
				log_history "GRUB updated. A system reboot is REQUIRED to apply XFS quota changes."
				echo "Important: A system reboot is REQUIRED to enable XFS quotas on root partition."
				reboot_req="Y"
			else
				log_history "XFS quota flags already present in GRUB configuration."
			fi
		else
			# /home is on separate partition - modify fstab
			log_history "/home is on separate partition ($mnt). Modifying fstab for XFS quota."
			
			# Check if quota options are already present
			if ! echo "$opt" | grep -qE "uquota|pquota|gquota"; then
				# Add XFS quota options to fstab
				new_opt="$opt,uquota,pquota,gquota"
				sed -i "$lnr s/$opt/$new_opt/" /etc/fstab
				check_result $? "Failed to modify fstab for XFS quota"
				systemctl daemon-reload
				mount -o remount "$mnt"
				log_history "XFS quota options added to fstab. A system reboot is recommended."
				echo "Note: A system reboot is recommended to fully enable XFS quotas."
				reboot_req="Y"
			else
				log_history "XFS quota options already present in fstab."
			fi
		fi
		;;
		
	ext4)
		log_history "ext4 filesystem detected on $mnt. Configuring quota."

		# Check if native quota is already enabled in filesystem
		native_quota_enabled=0
		if tune2fs -l "$mnt" 2>/dev/null | grep -q "^Filesystem features:.*quota"; then
			native_quota_enabled=1
			log_history "Native quota detected on ext4 filesystem."
		fi

		# Check current fstab configuration for external quotas
		external_quota_configured=0
		if echo "$opt" | grep -qE "usrquota|grpquota|usrjquota=|grpjquota=|jqfmt="; then
			external_quota_configured=1
			log_history "External quota configuration detected in fstab."
		fi

		# Decide which quota system to use
		if [ $native_quota_enabled -eq 1 ]; then
			# Use native quotas
			log_history "Using native ext4 quota support."
			
			# Remove external quota options from fstab if present
			if [ $external_quota_configured -eq 1 ]; then
				old=$(echo "$opt" | tr ',' '\n' | grep -vE 'usrquota|grpquota|usrjquota=|grpjquota=|jqfmt=' | tr '\n' ',' | sed 's/,$//')
				if [ -n "$old" ]; then
					sed -i "$lnr s/$opt/$old/" /etc/fstab
				fi
				systemctl daemon-reload
				mount -o remount "$mnt"
				log_history "Removed external quota options from fstab for native quota."
			fi
			
			# Ensure native quota is enabled
			if ! tune2fs -l "$mnt" 2>/dev/null | grep -q "^Filesystem features:.*quota"; then
				tune2fs -O quota "$mnt" > /dev/null 2>&1
				check_result $? "Failed to enable native quota on ext4 filesystem"
			fi
			
		else
			# Use external quotas (current configuration)
			log_history "Using external quota files for ext4."
			
			# Ensure that quota kernel modules are installed for external quotas
			if ! find "/lib/modules/$(uname -r)" -type f -name '*quota_v*.ko*' | grep -q '.*'; then
				# Install kernel modules for quota support.
				# Requires reboot to activate updated kernel.
				echo "Installing required kernel modules for quota support..."
				reboot_req="Y"
				apt-get -qq install linux-image-extra-virtual -y
				check_result $? "kernel module installation failed" "$E_UPDATE"
			fi
			
			fnd='usrquota\|grpquota\|usrjquota=aquota.user\|grpjquota=aquota.group\|jqfmt=vfsv0'
			new='usrquota,grpquota,usrjquota=aquota.user,grpjquota=aquota.group,jqfmt=vfsv0'

			# Modify /etc/fstab
			if [ "$(echo "$opt" | tr ',' '\n' | grep -c -xE "$fnd")" -ne "$(echo "$fnd" | tr '\|' '\n' | wc -l)" ]; then
				old=$(echo "$opt" | tr ',' '\n' | grep -vE 'usrquota|grpquota|usrjquota=|grpjquota=|jqfmt=|uquota|gquota' | tr '\n' ',' | sed 's/,$//')
				if [ -n "$old" ]; then
					sed -i "$lnr s/$opt/$old,$new/" /etc/fstab
				fi
				systemctl daemon-reload
				mount -o remount "$mnt"
			fi
			
			# Create quota files for external quotas
			if [ ! -e "$mnt/aquota.user" ] || [ ! -e "$mnt/aquota.group" ]; then
				quotacheck -avcugm > /dev/null 2>&1
			fi
		fi
		;;
		
	*)
		# Unsupported filesystem
		echo "Error: Hestia does not support quotas on $fs_type filesystem."
		log_history "Quota setup failed: $fs_type filesystem is not supported."
		exit "$E_DISK"
		;;
esac

# Adding quotacheck on reboot (only for ext4 with external quotas)
if [[ "$fs_type" == "ext4" ]] && [ $native_quota_enabled -eq 0 ]; then
	touch /forcequotacheck
	
	# Adding cron job for periodic quota check
	echo '#!/bin/bash' > /etc/cron.daily/quotacheck
	echo 'touch /forcequotacheck' >> /etc/cron.daily/quotacheck
	chmod a+x /etc/cron.daily/quotacheck
	log_history "Quotacheck cron job configured for external quotas."
else
	# Remove quotacheck cron job if it exists (not needed for XFS or native quotas)
	if [ -f /etc/cron.daily/quotacheck ]; then
		rm -f /etc/cron.daily/quotacheck
		log_history "Removed quotacheck cron job (not needed for $fs_type)."
	fi
fi

# Enabling group and user quota
if [ -n "$(quotaon -pa | grep " $mnt " | grep 'user\|group' | grep 'is off')" ]; then
	quotaon -v $mnt
	check_result $? "quota can't be enabled in $mnt" "$E_DISK"
fi

# Updating hestia.conf value
$BIN/v-change-sys-config-value "DISK_QUOTA" "yes"

# Rebuilding user quota (only if reboot is not required)
if [ "$reboot_req" != "Y" ]; then
	for user in $("$BIN/v-list-users" list); do
		"$BIN/v-update-user-quota" "$user"
	done
	log_history "User quotas updated successfully."
else
	# Create a one-time script to update quotas after reboot
	cat > /usr/local/hestia/bin/v-update-quotas-after-reboot.sh << 'EOF'
#!/bin/bash
BIN=/usr/local/hestia/bin
for user in $("$BIN/v-list-users" list); do
	"$BIN/v-update-user-quota" "$user"
done
# Self-delete after execution
rm -f /usr/local/hestia/bin/v-update-quotas-after-reboot.sh
rm -f /etc/cron.d/hestia-quota-reboot
EOF
	chmod +x /usr/local/hestia/bin/v-update-quotas-after-reboot.sh
	
	# Create one-time cron job
	cat > /etc/cron.d/hestia-quota-reboot << EOF
@reboot root sleep 30 && /usr/local/hestia/bin/v-update-quotas-after-reboot.sh
EOF
	chmod 644 /etc/cron.d/hestia-quota-reboot
	
	log_history "Created one-time job to update user quotas after reboot."
	echo "Note: User quotas will be automatically updated after the system reboots."
fi

#----------------------------------------------------------#
#                       Hestia                             #
#----------------------------------------------------------#

# Logging
$BIN/v-log-action "system" "Info" "Plugins" "System Quota enforcement enabled."
log_history "system quota enforcement enabled"
log_event "$OK" "$ARGUMENTS"

if [ "$reboot_req" = "Y" ]; then
	log_history "A system reboot is required to complete enable quota."
	echo "Note: A system reboot is required to complete quota setup."
fi

exit
